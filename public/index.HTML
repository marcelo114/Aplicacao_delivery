<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Delícia da Bel - Sistema Completo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        /* --- Seu CSS original (omitido aqui para foco no JS, mas você deve manter todo seu CSS) --- */
        /* Copie e cole todo o CSS que você já tinha aqui */
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --accent: #ffd166;
            --dark: #1a535c;
            --light: #f7fff7;
            --gray: #e0e0e0;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --proteina: #ff6b6b;
            --guarnicao: #06d6a0;
            --bebida: #118ab2;
            --suco: #9b5de5;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --transition: all 0.3s ease;
        }
        /* ... (todo seu CSS original continua aqui, sem alterações) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Página de Login -->
        <div id="login-page">
            <div class="header">
                <div class="logo">
                    <i class="fas fa-utensils"></i>
                </div>
                <h1>Delícia da Bel</h1>
                <p>Sistema de pedidos completo para sua conveniência</p>
            </div>
            
            <div class="card fade-in">
                <h2 class="card-title"><i class="fas fa-sign-in-alt"></i> Faça seu login</h2>
                <form id="loginForm" onsubmit="event.preventDefault(); handleLogin()">
                    <div class="form-group">
                        <label for="firstName">Seu nome completo</label>
                        <input type="text" id="firstName" placeholder="Nome" required />
                    </div>
                    <div class="form-group">
                        <label for="phone">Telefone</label>
                        <input
                            type="tel"
                            id="phone"
                            placeholder="(00) 00000-0000"
                            required
                            pattern="\([0-9]{2}\) [0-9]{5}-[0-9]{4}"
                        />
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>
            </div>
        </div>

        <!-- Aplicativo Principal -->
        <div id="main-app" class="hidden">
            <div class="header">
                <div class="logo">
                    <i class="fas fa-utensils"></i>
                </div>
                <h1>Delícia da Bel</h1>
                <p>Bem-vindo, <span id="logged-user"></span></p>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>

            <div class="app-container">
                <!-- Menu e Pedido -->
                <div class="menu-section card fade-in">
                    <h2 class="card-title"><i class="fas fa-book-open"></i> Cardápio</h2>
                    <div class="category-tabs" id="category-tabs"></div>
                    <div class="menu-grid" id="menu-items"></div>
                </div>

                <div class="order-summary card fade-in">
                    <h2 class="card-title"><i class="fas fa-receipt"></i> Resumo do Pedido</h2>
                    <div class="order-items-container" id="order-items-container"></div>
                    <div class="order-total">
                        <span>Total:</span>
                        <span>R$<span id="order-total">0.00</span></span>
                    </div>
                    <button class="btn btn-primary" onclick="showStep('delivery-step')">
                        <i class="fas fa-arrow-right"></i> Continuar
                    </button>
                </div>

                <!-- Etapa de Entrega -->
                <div id="delivery-step" class="step-section card hidden fade-in">
                    <h2 class="card-title"><i class="fas fa-truck"></i> Forma de Entrega</h2>
                    <div class="delivery-options">
                        <div class="delivery-card" onclick="selectDelivery('retirada')">
                            <i class="fas fa-store"></i>
                            <h3>Retirada no Local</h3>
                            <p>Venha buscar seu pedido</p>
                        </div>
                        <div class="delivery-card" onclick="selectDelivery('entrega')">
                            <i class="fas fa-motorcycle"></i>
                            <h3>Entrega</h3>
                            <p>Entregamos no seu endereço</p>
                        </div>
                    </div>

                    <div id="address-form-container" class="hidden">
                        <h3 class="card-title"><i class="fas fa-map-marker-alt"></i> Endereço de Entrega</h3>
                        <div class="form-group">
                            <label for="street">Rua</label>
                            <input type="text" id="street" placeholder="Nome da rua" required />
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="number">Número</label>
                                <input type="text" id="number" placeholder="Número" required />
                            </div>

                            <div class="form-group">
                                <label for="neighborhood">Bairro</label>
                                <input type="text" id="neighborhood" placeholder="Bairro" required />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="complement">Complemento</label>
                            <input type="text" id="complement" placeholder="Complemento" />
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="city">Cidade</label>
                                <input type="text" id="city" placeholder="Cidade" required />
                            </div>

                            <div class="form-group">
                                <label for="state">Estado</label>
                                <input type="text" id="state" placeholder="Estado" required />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="delivery-notes">Instruções de entrega</label>
                            <textarea id="delivery-notes" placeholder="Opcional" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="step-buttons">
                        <button class="btn btn-back" onclick="showStep('order-summary')">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                        <button class="btn btn-primary" id="continue-to-payment" onclick="proceedToPayment()" disabled>
                            Continuar <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Etapa de Pagamento -->
                <div id="payment-step" class="step-section card hidden fade-in">
                    <h2 class="card-title"><i class="fas fa-credit-card"></i> Forma de Pagamento</h2>

                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-receipt"></i> Resumo do Pedido</h3>
                        <div id="review-items"></div>
                        <div class="receipt-item">
                            <span>Entrega:</span>
                            <span id="delivery-type-review"></span>
                        </div>
                        <div class="receipt-total">
                            <span>Total:</span>
                            <span>R$<span id="review-total">0.00</span></span>
                        </div>
                    </div>

                    <div class="delivery-options">
                        <div class="delivery-card" onclick="selectPayment('dinheiro')">
                            <i class="fas fa-money-bill-wave"></i>
                            <h3>Dinheiro</h3>
                            <p>Pagamento na entrega</p>
                        </div>
                        <div class="delivery-card" onclick="selectPayment('cartao')">
                            <i class="fas fa-credit-card"></i>
                            <h3>Cartão</h3>
                            <p>Débito ou crédito</p>
                        </div>
                        <div class="delivery-card" onclick="selectPayment('pix')">
                            <i class="fas fa-qrcode"></i>
                            <h3>PIX</h3>
                            <p>Pagamento instantâneo</p>
                        </div>
                    </div>

                    <div id="change-container" class="hidden">
                        <div class="form-group">
                            <label for="change-amount">Troco para quanto?</label>
                            <input type="number" id="change-amount" placeholder="Ex: 50.00" min="0" step="0.01" />
                        </div>
                    </div>

                    <div class="step-buttons">
                        <button class="btn btn-back" onclick="showStep('delivery-step')">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                        <button class="btn btn-primary" onclick="generateReceipt()">
                            <i class="fas fa-print"></i> Imprimir Pedido
                        </button>
                    </div>
                </div>

                <!-- Comprovante para Impressão -->
                <div id="receipt-step" class="step-section card hidden fade-in">
                    <h2 class="card-title"><i class="fas fa-check-circle"></i> Pedido Confirmado!</h2>

                    <div class="receipt-container">
                        <div class="receipt-header">
                            <h2 class="receipt-title">DELÍCIA DA BEL</h2>
                            <p>Comprovante de Pedido</p>

                            <!-- Informações do cliente adicionadas aqui -->
                            <div class="client-info">
                                <div><strong>Cliente:</strong> <span id="receipt-client-name"></span></div>
                                <div><strong>Telefone:</strong> <span id="receipt-client-phone"></span></div>
                            </div>

                            <p id="receipt-date"></p>
                        </div>

                        <div class="receipt-line"></div>

                        <div id="receipt-items"></div>

                        <div class="receipt-item">
                            <span>Entrega:</span>
                            <span id="receipt-delivery-type"></span>
                        </div>

                        <div class="receipt-item">
                            <span>Pagamento:</span>
                            <span id="receipt-payment-method"></span>
                        </div>

                        <div id="receipt-change-container" class="receipt-item hidden">
                            <span>Troco para:</span>
                            <span>R$<span id="receipt-change-amount"></span></span>
                        </div>

                        <div id="receipt-address" class="receipt-address hidden">
                            <h4 style="font-family: 'Courier New', monospace; color: var(--dark); margin-bottom: 5px;">
                                ENDEREÇO DE ENTREGA
                            </h4>
                            <div id="receipt-address-details"></div>
                        </div>

                        <div class="receipt-line"></div>

                        <div class="receipt-item receipt-total">
                            <span>TOTAL:</span>
                            <span>R$<span id="receipt-total">0.00</span></span>
                        </div>

                        <p style="text-align: center; margin: 20px 0; font-style: italic;">
                            Obrigado pela sua preferência! Seu pedido está sendo preparado.
                        </p>

                        <button class="print-btn" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimir Comprovante
                        </button>
                        <button class="print-btn whatsapp-btn" onclick="shareOrderViaWhatsApp()">
                            <i class="fab fa-whatsapp"></i> Enviar Pedido pelo WhatsApp
                        </button>
                    </div>

                    <div class="step-buttons">
                        <button class="btn btn-primary" onclick="resetToMenu()">
                            <i class="fas fa-home"></i> Voltar ao Início
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Declara variáveis globais para evitar ReferenceError
    let order = [];
    let currentStep = "menu";
    let deliveryType = "";
    let paymentMethod = "";

    // Dados do cardápio
    const menuItems = [
        { id: 1, name: "Bisteca de gado acebolado", price: 15.0, category: "proteina" },
        { id: 2, name: "Almôndegas cebolada", price: 13.0, category: "proteina" },
        { id: 3, name: "Calabresa acebolada", price: 13.0, category: "proteina" },
        { id: 4, name: "Frango ao molho", price: 13.0, category: "proteina" },
        { id: 5, name: "Porco cozido", price: 13.0, category: "proteina" },
        { id: 6, name: "Peixe frito", price: 13.0, category: "proteina" },
        { id: 7, name: "Arroz", price: 0.0, category: "guarnicao" },
        { id: 8, name: "Feijão", price: 0.0, category: "guarnicao" },
        { id: 9, name: "Farofa", price: 0.0, category: "guarnicao" },
        { id: 10, name: "Salada", price: 0.0, category: "guarnicao" },
        { id: 18, name: "Macarrão", price: 0.0, category: "guarnicao" },
        { id: 11, name: "Refrigerante Pequeno", price: 5.0, category: "bebida" },
        { id: 12, name: "Refrigerante Grande", price: 8.0, category: "bebida" },
        { id: 13, name: "Suco de Maracujá", price: 6.0, category: "suco" },
        { id: 14, name: "Suco de Goiaba", price: 6.0, category: "suco" },
        { id: 15, name: "Suco de Melancia", price: 6.0, category: "suco" },
        { id: 16, name: "Suco de Tomate", price: 6.0, category: "suco" },
        { id: 17, name: "Suco de Manga", price: 6.0, category: "suco" }
    ];

    // Função para login e validação simples
    function handleLogin() {
        const firstNameInput = document.getElementById("firstName");
        const phoneInput = document.getElementById("phone");
        const firstName = firstNameInput.value.trim();
        const phone = phoneInput.value.trim();

        if (!firstName || !phone.match(/^\([0-9]{2}\) [0-9]{5}-[0-9]{4}$/)) {
            alert("Por favor, preencha todos os campos corretamente.");
            return;
        }

        localStorage.setItem("client", JSON.stringify({ firstName, phone }));
        document.getElementById("logged-user").textContent = firstName;
        document.getElementById("login-page").classList.add("hidden");
        document.getElementById("main-app").classList.remove("hidden");

        loadMenu();
    }

    // Carrega as abas e itens do menu
    function loadMenu() {
        const tabsContainer = document.getElementById("category-tabs");
        const menuContainer = document.getElementById("menu-items");
        tabsContainer.innerHTML = "";
        menuContainer.innerHTML = "";

        const categories = [
            { id: "proteina", name: "Proteína" },
            { id: "guarnicao", name: "Guarnição" },
            { id: "bebida", name: "Bebida" },
            { id: "suco", name: "Suco" }
        ];

        categories.forEach(category => {
            const tab = document.createElement("div");
            tab.className = `category-tab ${category.id} ${
                category.id === "proteina" ? "active" : ""
            }`;
            tab.textContent = category.name;
            tab.dataset.category = category.id;
            tab.onclick = () => filterMenu(category.id);
            tabsContainer.appendChild(tab);
        });

        filterMenu("proteina");
    }

    // Filtra e exibe itens por categoria
    function filterMenu(categoryId) {
        const menuContainer = document.getElementById("menu-items");
        const tabs = document.querySelectorAll(".category-tab");

        tabs.forEach(tab => {
            tab.classList.toggle("active", tab.dataset.category === categoryId);
        });

        menuContainer.innerHTML = "";

        const filteredItems = menuItems.filter(item => item.category === categoryId);

        filteredItems.forEach(item => {
            const menuItem = document.createElement("div");
            menuItem.className = `menu-item ${item.category}`;
            menuItem.innerHTML = `
                <div class="menu-item-content">
                    <h3>${item.name}</h3>
                    <div class="menu-item-footer">
                        <div class="price">${
                            item.price > 0 ? "R$" + item.price.toFixed(2) : "Incluso"
                        }</div>
                        <button class="add-btn" onclick="addToOrder(${item.id}, event)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;
            menuContainer.appendChild(menuItem);
        });
    }

    // Adiciona item ao pedido
    function addToOrder(itemId, event) {
        const item = menuItems.find(i => i.id === itemId);
        if (!item) return;

        const existingItem = order.find(i => i.id === itemId);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            order.push({
                id: item.id,
                name: item.name,
                price: item.price,
                quantity: 1,
                category: item.category
            });
        }

        updateOrderSummary();

        // Feedback visual
        const button = event?.target.closest("button");
        if (button) {
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.style.background = "#06d6a0";
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-plus"></i>';
                button.style.background = "";
            }, 1500);
        }
    }

    // Atualiza resumo do pedido e habilita/desabilita botão Continuar
    function updateOrderSummary() {
        const container = document.getElementById("order-items-container");
        const totalElement = document.getElementById("order-total");
        const continueBtn = document.querySelector(".order-summary .btn-primary");

        container.innerHTML = "";

        if (order.length === 0) {
            container.innerHTML =
                '<p style="text-align: center; padding: 20px; color: #777;">Seu pedido está vazio</p>';
            totalElement.textContent = "0.00";
            if (continueBtn) continueBtn.disabled = true;
            return;
        }

        if (continueBtn) continueBtn.disabled = false;

        let total = 0;

        // Agrupa por categoria
        const categories = {};
        order.forEach(item => {
            if (!categories[item.category]) {
                categories[item.category] = [];
            }
            categories[item.category].push(item);
        });

        for (const category in categories) {
            const categoryTitle = document.createElement("div");
            categoryTitle.style.marginTop = "15px";
            categoryTitle.style.fontWeight = "bold";
            categoryTitle.style.color = "var(--" + category + ")";
            categoryTitle.textContent =
                category === "proteina"
                    ? "PROTEÍNAS"
                    : category === "guarnicao"
                    ? "GUARNIÇÕES"
                    : category === "bebida"
                    ? "BEBIDAS"
                    : "SUCOS";
            container.appendChild(categoryTitle);

            categories[category].forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const orderItem = document.createElement("div");
                orderItem.className = "order-item";
                orderItem.innerHTML = `
                    <div class="item-info">
                        <strong>${item.name}</strong>
                        ${item.price > 0 ? `<div>R$${item.price.toFixed(2)} × ${item.quantity}</div>` : ""}
                    </div>
                    <div class="item-actions">
                        <div class="quantity-control">
                            <div class="quantity-btn" onclick="changeQuantity(${item.id}, -1)">
                                <i class="fas fa-minus"></i>
                            </div>
                            <span>${item.quantity}</span>
                            <div class="quantity-btn" onclick="changeQuantity(${item.id}, 1)">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        <button class="delete-btn" onclick="removeFromOrder(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(orderItem);
            });
        }

        totalElement.textContent = total.toFixed(2);
    }

    // Ajusta quantidade
    function changeQuantity(itemId, change) {
        const item = order.find(i => i.id === itemId);
        if (!item) return;

        item.quantity += change;

        if (item.quantity <= 0) {
            removeFromOrder(itemId);
        } else {
            updateOrderSummary();
        }
    }

    // Remove item do pedido
    function removeFromOrder(itemId) {
        order = order.filter(item => item.id !== itemId);
        updateOrderSummary();
    }

    // Controla a habilitação do botão Continuar e exibe formulário endereço
    function selectDelivery(type) {
        deliveryType = type;
        const cards = document.querySelectorAll(".delivery-card");
        const addressForm = document.getElementById("address-form-container");
        const continueBtn = document.getElementById("continue-to-payment");

        cards.forEach(card => {
            card.classList.toggle(
                "selected",
                card.querySelector("h3").textContent.includes(type === "retirada" ? "Retirada" : "Entrega")
            );
        });

        addressForm.classList.toggle("hidden", type === "retirada");

        if (type === "retirada") {
            continueBtn.disabled = order.length === 0;
        } else {
            continueBtn.disabled = !validateAddress() || order.length === 0;
        }
    }

    // Valida o endereço de entrega
    function validateAddress() {
        if (deliveryType !== "entrega") return true;

        const requiredFields = ["street", "number", "neighborhood", "city", "state"];
        return requiredFields.every(field => document.getElementById(field).value.trim() !== "");
    }

    // Validação dinâmica no formulário de endereço
    function setupAddressValidation() {
        const fields = ["street", "number", "neighborhood", "city", "state"];
        const continueBtn = document.getElementById("continue-to-payment");

        fields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                element.addEventListener("input", () => {
                    if (deliveryType === "entrega") {
                        continueBtn.disabled = !validateAddress();
                    }
                });
            }
        });
    }

    // Prossegue para etapa de pagamento
    function proceedToPayment() {
        if (!deliveryType) {
            alert("Selecione uma forma de entrega!");
            return;
        }

        if (deliveryType === "entrega" && !validateAddress()) {
            alert("Por favor, preencha todos os campos obrigatórios do endereço.");
            return;
        }

        showStep("payment-step");
    }

    // Seleciona método de pagamento e mostra campo troco se necessário
    function selectPayment(method) {
        paymentMethod = method;
        const cards = document.querySelectorAll("#payment-step .delivery-card");
        const changeContainer = document.getElementById("change-container");

        cards.forEach(card => {
            card.classList.toggle(
                "selected",
                card.querySelector("h3").textContent ===
                    (method === "dinheiro" ? "Dinheiro" : method === "cartao" ? "Cartão" : "PIX")
            );
        });

        changeContainer.classList.toggle("hidden", method !== "dinheiro");
    }

    // Gera o comprovante e mostra
    function generateReceipt() {
        if (order.length === 0) {
            alert("Seu pedido está vazio!");
            return;
        }

        if (!deliveryType) {
            alert("Selecione a forma de entrega!");
            showStep("delivery-step");
            return;
        }

        if (!paymentMethod) {
            alert("Selecione a forma de pagamento!");
            showStep("payment-step");
            return;
        }

        const container = document.getElementById("receipt-items");
        const deliveryElement = document.getElementById("receipt-delivery-type");
        const paymentElement = document.getElementById("receipt-payment-method");
        const totalElement = document.getElementById("receipt-total");
        const addressContainer = document.getElementById("receipt-address");
        const addressDetails = document.getElementById("receipt-address-details");
        const changeContainer = document.getElementById("receipt-change-container");
        const changeAmountElement = document.getElementById("receipt-change-amount");
        const receiptDate = document.getElementById("receipt-date");

        // Dados do cliente
        const client = JSON.parse(localStorage.getItem("client")) || {};
        document.getElementById("receipt-client-name").textContent = client.firstName || "Não informado";
        document.getElementById("receipt-client-phone").textContent = client.phone || "Não informado";

        // Data/hora atual formatada
        const now = new Date();
        receiptDate.textContent = now.toLocaleString("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });

        container.innerHTML = "";
        let total = 0;

        order.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            const itemElement = document.createElement("div");
            itemElement.className = "receipt-item";
            itemElement.innerHTML = `
                <span>${item.quantity}x ${item.name}</span>
                <span>${item.price > 0 ? "R$" + itemTotal.toFixed(2) : ""}</span>
            `;
            container.appendChild(itemElement);
        });

        // Taxa entrega se houver
        if (deliveryType === "entrega") {
            const deliveryItem = document.createElement("div");
            deliveryItem.className = "receipt-item";
            deliveryItem.innerHTML = `
                <span>Taxa de Entrega</span>
                <span>R$5.00</span>
            `;
            container.appendChild(deliveryItem);
            total += 5;
        }

        deliveryElement.textContent = deliveryType === "retirada" ? "Retirada" : "Entrega";
        paymentElement.textContent =
            paymentMethod === "dinheiro" ? "Dinheiro" : paymentMethod === "cartao" ? "Cartão" : "PIX";

        if (paymentMethod === "dinheiro") {
            const changeAmount = parseFloat(document.getElementById("change-amount").value) || 0;
            changeContainer.classList.remove("hidden");
            changeAmountElement.textContent = changeAmount.toFixed(2);
        } else {
            changeContainer.classList.add("hidden");
        }

        if (deliveryType === "entrega") {
            addressContainer.classList.remove("hidden");
            addressDetails.innerHTML = `
                <div>${document.getElementById("street").value}, ${document.getElementById("number").value}</div>
                <div>${document.getElementById("neighborhood").value}</div>
                <div>${
                    document.getElementById("complement").value
                        ? "Complemento: " + document.getElementById("complement").value
                        : ""
                }</div>
                <div>${document.getElementById("city").value} - ${document.getElementById("state").value}</div>
                <div>${
                    document.getElementById("delivery-notes").value
                        ? "Instruções: " + document.getElementById("delivery-notes").value
                        : ""
                }</div>
            `;
        } else {
            addressContainer.classList.add("hidden");
        }

        totalElement.textContent = total.toFixed(2);

        showStep("receipt-step");
    }

    // Compartilha pedido via WhatsApp
    function shareOrderViaWhatsApp() {
        const client = JSON.parse(localStorage.getItem("client") || "{}");
        const now = new Date();
        const orderDate = now.toLocaleString("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });

        let message = `*Novo Pedido - Delícia da Bel*\n\n`;
        message += `*Data/Hora:* ${orderDate}\n`;
        message += `*Cliente:* ${client.firstName || "Não informado"}\n`;
        message += `*Telefone:* ${client.phone || "Não informado"}\n\n`;

        message += `*Itens do Pedido:*\n`;
        let total = 0;
        order.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            message += `${item.quantity}x ${item.name} - ${
                item.price > 0 ? "R$" + itemTotal.toFixed(2) : "Incluso"
            }\n`;
        });

        if (deliveryType === "entrega") {
            message += `Taxa de Entrega - R$5.00\n`;
            total += 5;
        }

        message += `\n*Total:* R$${total.toFixed(2)}\n`;
        message += `\n*Entrega:* ${deliveryType === "retirada" ? "Retirada no Local" : "Entrega"}\n`;

        if (deliveryType === "entrega") {
            message += `\n*Endereço de Entrega:*\n`;
            message += `${document.getElementById("street").value}, ${document.getElementById("number").value}\n`;
            message += `${document.getElementById("neighborhood").value}\n`;
            if (document.getElementById("complement").value) {
                message += `Complemento: ${document.getElementById("complement").value}\n`;
            }
            message += `${document.getElementById("city").value} - ${document.getElementById("state").value}\n`;
            if (document.getElementById("delivery-notes").value) {
                message += `Instruções: ${document.getElementById("delivery-notes").value}\n`;
            }
        }

        message += `\n*Método de Pagamento:* ${
            paymentMethod === "dinheiro" ? "Dinheiro" : paymentMethod === "cartao" ? "Cartão" : "PIX"
        }\n`;

        if (paymentMethod === "dinheiro") {
            const changeAmount = parseFloat(document.getElementById("change-amount").value) || 0;
            message += `*Troco para:* R$${changeAmount.toFixed(2)}\n`;
        }

        const restaurantPhone = "558893240461";

        const encodedMessage = encodeURIComponent(message);
        const whatsappLink = `https://wa.me/${restaurantPhone}?text=${encodedMessage}`;
        window.open(whatsappLink, "_blank");
    }

    // Formata telefone no input
    document.getElementById("phone").addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 11) value = value.slice(0, 11);

        if (value.length > 10) {
            value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7, 11)}`;
        } else if (value.length > 5) {
            value = `(${value.substring(0, 2)}) ${value.substring(2, 6)}-${value.substring(6)}`;
        } else if (value.length > 2) {
            value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
        } else if (value.length > 0) {
            value = `(${value}`;
        }

        e.target.value = value;
    });

    // Mostra/esconde etapas e faz scroll para topo
    function showStep(step) {
        document.querySelectorAll(".step-section").forEach(el => el.classList.add("hidden"));
        const el = document.getElementById(step);
        if (el) el.classList.remove("hidden");
        currentStep = step;

        window.scrollTo(0, 0);

        if (step === "payment-step") {
            updatePaymentSummary();
        }
    }

    // Atualiza resumo da etapa pagamento
    function updatePaymentSummary() {
        const container = document.getElementById("review-items");
        const deliveryElement = document.getElementById("delivery-type-review");
        const totalElement = document.getElementById("review-total");

        container.innerHTML = "";

        if (order.length === 0) {
            container.innerHTML = "<p>Nenhum item no pedido</p>";
            totalElement.textContent = "0.00";
            return;
        }

        let total = 0;

        order.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            const orderItem = document.createElement("div");
            orderItem.className = "receipt-item";
            orderItem.innerHTML = `
                <span>${item.quantity}x ${item.name}</span>
                <span>${item.price > 0 ? "R$" + itemTotal.toFixed(2) : ""}</span>
            `;
            container.appendChild(orderItem);
        });

        if (deliveryType === "entrega") {
            const deliveryItem = document.createElement("div");
            deliveryItem.className = "receipt-item";
            deliveryItem.innerHTML = `
                <span>Taxa de Entrega</span>
                <span>R$5.00</span>
            `;
            container.appendChild(deliveryItem);
            total += 5;
        }

        deliveryElement.textContent = deliveryType === "retirada" ? "Retirada" : "Entrega";
        totalElement.textContent = total.toFixed(2);
    }

    // Logout e reset
    function logout() {
        localStorage.removeItem("client");
        window.location.reload();
    }

    // Reseta app para o início (após impressão)
    function resetToMenu() {
        order = [];
        deliveryType = "";
        paymentMethod = "";

        // Limpa formulário endereço e troco
        ["street", "number", "neighborhood", "complement", "city", "state", "delivery-notes", "change-amount"].forEach(
            id => {
                const el = document.getElementById(id);
                if (el) el.value = "";
            }
        );

        // Limpa seleção
        document.querySelectorAll(".delivery-card").forEach(card => card.classList.remove("selected"));

        updateOrderSummary();
        showStep("menu");
    }

    // Setup ao carregar página
    window.addEventListener("load", () => {
        try {
            const client = localStorage.getItem("client");
            if (client) {
                const { firstName } = JSON.parse(client);
                document.getElementById("logged-user").textContent = firstName;
                document.getElementById("login-page").classList.add("hidden");
                document.getElementById("main-app").classList.remove("hidden");
                loadMenu();
            }
        } catch {
            localStorage.removeItem("client");
        }

        updateOrderSummary();
        setupAddressValidation();
    });
</script>
</body>
</html>
